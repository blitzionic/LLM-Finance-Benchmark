import os
import json
from base_agent import Agent
from answer_schema import AnswerSchema

# Intitial Generator -> Reviewer -> Challenger Agent 
# The Reviewer Agent is intended to “review” the initial generated solution. 
# It reviews the solution returns its own answer. 

FUNCTION_SCHEMA = {
    "name": "generate_answer",
    "description": "Generate a candidate answer along with a brief explanation. The candidate answer must be one letter among A, B, C, or D.",
    "parameters": {
        "type": "object",
        "properties": {
            "answer": {
                "type": "string",
                "enum": ["A", "B", "C", "D"],
                "description": "The candidate answer, which must be one letter: A, B, C, or D."
            },
            "reasoning": {
                "type": "string",
                "description": "A brief explanation of the reasoning behind the chosen answer."
            }
        },
        "required": ["answer", "reasoning"]
    }
}

class ReviewerAgent(Agent):
    def __init__(self, topic, model="gpt-4o-mini", topic_roles_json="topic_roles.json"):
        if os.path.exists(topic_roles_json):
            with open(topic_roles_json, 'r', encoding='utf-8') as f:
                roles = json.load(f) 
        else:
            roles = {}
            print(f"Warning: {topic_roles_json} not found. Using default role.")
            
        self.topic = topic 
        self.role_description = roles.get(topic.lower(), "")
        super().__init__(model=model, function_schema=FUNCTION_SCHEMA, pyd_model=AnswerSchema)
    
    def system_prompt(self):
        return (
            f"{self.role_description}\n" 
            "Your job is to review an answer generated by an initial solution generator for a multiple-choice finance question. "
            "Consider the original question, the provided initial answer, and your own expertise in finance to critically assess the answer’s "
            "strengths and weaknesses. Identify any gaps in reasoning or potential errors, and then determine what you believe is the correct "
            "answer. Answer the following multiple-choice question by selecting one letter: A, B, C, or D, and provide your reasoning. "
            "If your answer choice selection differs from the inital answer, you must explain why."
        )
    
    def process(self, question, initial_answer, initial_reasoning):
        prompt = (
            "Review the question and the initial answer thoroughly. "
            "Assess its strengths and weaknesses, and then determine provide an improved answer with better reasoning if applicable."
            "Select the best final answer and provide your reasoning.\n"
            f"Original Question: {question}\n"
            f"Initial Answer: {initial_answer}\n"
            f"Initial Reasoning: {initial_reasoning}"
        )
        response = self.generate_response(prompt)
        return response